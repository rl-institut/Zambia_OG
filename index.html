<!Doctype html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Zambia Map</title>
		
		<!-- font awesome offers symbols/icons. used e.g. as symbols for the tabs on the sidebar -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
		<!-- Stylesheet for Leaflet icons, fonts etc -->
		<link rel="stylesheet" href="css/leaflet.css"/>
        <link rel="stylesheet" href="css/leaflet-sidebar.min.css" />
		<!-- Stylesheet for nouislider -->
        <link rel="stylesheet" href="css/nouislider.min.css" />
		<!-- Stylesheet defines map extent -->
		<link rel="stylesheet" href="css/styles.css"/>


	</head>


	<body>

		<!--Leaflet - JS-library for slippy maps -->		
		<script src="javascript/leaflet.js"></script>
		<!--jquery - enables loading a GeoJson from a file directly into Leaflet -->
		<script src="javascript/jquery.min.js"></script>
		<!--enables loading vectortiles -->
        <script src="javascript/Leaflet.VectorGrid.bundled.js"></script>
		<!--enables pretty checkboxes and advanced slider functions -->
        <script src="javascript/nouislider.min.js"></script>
		<!--enables the leaflet-sidebar -->
        <script src="javascript/leaflet-sidebar.min.js"></script>
		
		<!--importing js-files with geojson inside. this approach is chosen, since loading geojson-files directly into a variable can be problematic  -->
		<!--postoffices.js contains a javascript variable named "postoffices" with all geojson objects inside -->
		<script src="data/sampledata_postoffices.js" type="text/javascript"></script> 
		<!--provinces.js contains a javascript variable named "provinces" with all geojson objects inside -->
		<script src="data/sampledata_provinces.js" type="text/javascript"></script> 
		<!--nouislider enables better looking checkboxes and more functional sliders -->







		<div id="map"></div>
		

    <div id="sidebar" class="leaflet-sidebar">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#bert" role="tab"><i class="fa fa-key"></i></a></li>
                <li><a href=#layers role="tab"><i class="fa fa-layer-group"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fa fa-filter"></i></a></li>
                <li><a href="#download" role="tab"><i class="fa fa-arrow-circle-down"></i></a></li>                
                <li><a href="#about" role="tab"><i class="fa fa-question-circle"></i></a></li>
            </ul>
        </div>
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
                     Title next to Sidebar Icon
                    <div class="leaflet-sidebar-close"><i class="fa fa-times"></i></div>
                </h1>
                <p> html content in paragraph. You may include an image as well:</p>
                
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
                </a><br />The image links to the CC-website. Here is the same link again: <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0</a>.</p>
            </div>


            <div class="leaflet-sidebar-pane" id="layers">
                <h1 class="leaflet-sidebar-header">Layers<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>

                <h3>Select Basemap Layer </h3>
                <img class="basemap_preview" id="aerial_preview" src="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/6/34/36.png" onclick="SelectBasemap('Esri Aerial')" />
                Aerial Images (Esri) <br> 
                <img class="basemap_preview" id="gray_preview" src="https://tiles.wmflabs.org/bw-mapnik/6/36/34.png" onclick="SelectBasemap('Grayscale')"/>
                OpenStreetMap-Gray <br> 
                <img class="basemap_preview" id="osm_preview" src="https://a.tile.openstreetmap.org/6/36/34.png" onclick="SelectBasemap('OpenStreetMap')"/>
                OpenStreetMap <br> 
                <img class="basemap_preview" id="topo_preview" src="https://a.tile.opentopomap.org/6/36/34.png" onclick="SelectBasemap('OpenTopoMap')"/>
                OpenTopoMap <br> 
                </p>


                <script>
                function url_from_coords(zoom, coords) {
                   xtile = long2tile(coords.lng,zoom);
                   ytile = long2tile(coords.lat * -1,zoom);
                   return zoom + "/" + xtile + "/" + ytile;
                }
                function url_from_coords_yx(zoom, coords) {
                   xtile = long2tile(coords.lng,zoom);
                   ytile = long2tile(coords.lat * -1,zoom);
                   return zoom + "/" + ytile + "/" + xtile;
                }

                function long2tile(lon,zoom) { return (Math.floor((lon+180)/360*Math.pow(2,zoom))); }
                function lat2tile(lat,zoom)  { return (Math.floor((1-Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180))/Math.PI)/2 *Math.pow(2,zoom))); }


                function RefreshPreview(){
                    document.getElementById("topo_preview").src="https://a.tile.opentopomap.org/" + url_from_coords(map.getZoom(), map.getCenter()) + ".png"
                    document.getElementById("gray_preview").src="https://tiles.wmflabs.org/bw-mapnik/" + url_from_coords(map.getZoom(), map.getCenter()) + ".png"
                    document.getElementById("osm_preview").src="https://a.tile.openstreetmap.org/" + url_from_coords(map.getZoom(), map.getCenter()) + ".png"
                    document.getElementById("aerial_preview").src="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/" + url_from_coords_yx(map.getZoom(), map.getCenter()) + ".png"
                    }

                function SelectBasemap(input){
                    var i;
                    var maps = ["Esri Aerial", "OpenStreetMap-Gray", "OpenStreetMap", "OpenTopoMap"];
                    for (i = 0; i < maps.length; i++){
                        if (map.hasLayer(baseMaps[maps[i]]) && maps[i] != input)
                            {
                            map.removeLayer(baseMaps[maps[i]]);
                            //alert(maps[i]);
                            }
                    }
                    map.addLayer(baseMaps[input]);
                }
                
    

                </script>

<!--
                basemap layer seletor with radio buttons
                <form action="">
                  <input type="radio" name="basemap" id="Esri Aerial" onclick="BaseMapSwitch()" checked> Aerial Images (Esri)<br>
                  <input type="radio" name="basemap" id="OpenStreetMap" onclick="BaseMapSwitch()" > OpenStreetMap<br>
                  <input type="radio" name="basemap" id="Grayscale" onclick="BaseMapSwitch()" > OpenStreetMap-Gray<br>
                  <input type="radio" name="basemap" id="OpenTopoMap" onclick="BaseMapSwitch()" > OpenTopoMap<br>
                </form>

                <script>
                function BaseMapSwitch() {
                    var x = document.getElementsByName("basemap");
                    var i;
                    for (i = 0; i < x.length; i++) {
                        if (x[i].checked){
                            map.addLayer(baseMaps[x[i].id]);
                        }
                        else {
                            map.removeLayer(baseMaps[x[i].id]);
                        }    
                        
                    }
                }


                </script>
-->
                <h3>Select Overlay Information </h3>
                <br>
                 <label class="switch"> 
                    <input checked type="checkbox" onclick="toggleVecTileLayer()" id="toggle_vl"/>
                    <span class="slider"></span>
                </label> Show Clusters

                <script>

                function toggleVecTileLayer()
                {
                  var checkbox = document.getElementById('toggle_vl');
                  if (checkbox.checked == false)
                      {
                        if (map.hasLayer(vecTileLayer))
                            {
                            map.removeLayer(vecTileLayer);
                            }
                      }
                  else
                      {
                        map.addLayer(vecTileLayer);
                      }
                }
                </script>
                <br>
                <br>
                 <label class="switch"> 
                    <input checked type="checkbox" name="togglebutton" onclick="toggleBorders()" id="Borders"/>
                    <span class="slider"></span>
                </label> Show Borders

                <br>
                <br>
                 <label class="switch"> 
                    <input type="checkbox" name="togglebutton" onclick="toggleBorders()" id="Postoffices"/>
                    <span class="slider"></span>
                </label> Show Postoffices


                <script>
                function toggleBorders(){
                    var checkboxes = document.getElementsByName('togglebutton');
                    var j;
                    for (j = 0; j < checkboxes.length; j++) {
                        //alert(typeof(checkboxes[j].id));
                        if (checkboxes[j].checked == false)
                        {
                            //alert(typeof(gray));
                            map.removeLayer(overlaymaps[checkboxes[j].id]);
                        }
                        else {
                            map.addLayer(overlaymaps[checkboxes[j].id]);
                        }   
                    }
                }
                

                </script>
            </div>


            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">What a nice Filter Symbol<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h3>headdy McHeadline</h3> Paragraphy McParagraph.<br> create filters for data below 
                     <h3>Population range</h3> 
                        Use this to filter the results to a desired population range. (filter currently inert) <br><br>
                <div id="sliderpop"></div> <br>
                    <div>
                        <input type="number" id="input-with-keypress-0" name="range" />
                        <input type="number" id="input-with-keypress-1" name="range" />
                    </div>
            </div>

            <script>
            var keypressSlider = document.getElementById('sliderpop');
            var input0 = document.getElementById('input-with-keypress-0');
            var input1 = document.getElementById('input-with-keypress-1');
            var inputs = [input0, input1];

            noUiSlider.create(keypressSlider, {
	            start: [42, 512],
	            connect: true,
	            //direction: 'rtl',
	            //tooltips: [true, wNumb({ decimals: 1 })],
	            range: {
		            'min': [0, 1],
		            'max': 1337
	            }
            });

            keypressSlider.noUiSlider.on('update', function( values, handle ) {
	            inputs[handle].value = values[handle];
            });



            function setSliderHandle(i, value) {
	            var r = [null,null];
	            r[i] = value;
	            keypressSlider.noUiSlider.set(r);
            }

            // Listen to keydown events on the input field.
            inputs.forEach(function(input, handle) {

	            input.addEventListener('change', function(){
		            setSliderHandle(handle, this.value);
	            });

	            input.addEventListener('keydown', function( e ) {

		            var values = keypressSlider.noUiSlider.get();
		            var value = Number(values[handle]);
		            // [[handle0_down, handle0_up], [handle1_down, handle1_up]]
		            var steps = keypressSlider.noUiSlider.steps();
		            // [down, up]
		            var step = steps[handle];
		            var position;

		            // 13 is enter,
		            // 38 is key up,
		            // 40 is key down.
		            switch ( e.which ) {
			            case 13:
				            setSliderHandle(handle, this.value);
				            break;
			            case 38:
				            // Get step to go increase slider value (up)
				            position = step[1];
				            // false = no step is set
				            if ( position === false ) {
					            position = 1;
				            }
				            // null = edge of slider
				            if ( position !== null ) {
					            setSliderHandle(handle, value + position);
				            }

				            break;
			            case 40:
				            position = step[0];
				            if ( position === false ) {
					            position = 1;
				            }
				            if ( position !== null ) {
					            setSliderHandle(handle, value - position);
				            }
				            break;
		            }
	            });
            });

            </script>


            <div class="leaflet-sidebar-pane" id="about">
                <h1 class="leaflet-sidebar-header">
                     About the map
                    <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                </h1>
               <p>Source code for the webmap can be found <a href="https://github.com/rl-institut/Zambia_OG" target="_blank">here</a>.</p>
                <p class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
            </div>


            <div class="leaflet-sidebar-pane" id="download">
                <h1 class="leaflet-sidebar-header">
                        Downloady
                        <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                    </h1>
                <p>Lorem ipsum dolores paragraphum</p>
            </div>


            <div class="leaflet-sidebar-pane" id="bert">
                <h1 class="leaflet-sidebar-header">
                        Key
                        <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                    </h1>
                <p>Every Map needs a key.</p>
            </div>


        </div>
    </div>


		<script>
			let options = {
				center: [-13.22, 27.85],
				zoom: 6,
				minZoom: 6,
				maxZoom: 16,
				zoomControl: false,
				//maxBounds: [[-24, 7],[-2, 48]]
			}

			//
			// Create empty leaflet-map (named "map") on canvas with parameters defined in options
			//

			let map = L.map("map", options);



			//
			// Definition of Basemap-Tile Sources to add map 
			// find more basemaps here (please inspect licenses): https://mc.bbbike.org/mc/?num=2&mt0=mapnik&mt1=mapnik-bw
			//

			
			let gray = L.tileLayer("https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png", {
			    maxZoom: 19,
			    attribution: '&copy; <a href="http://www.wfmlabs.org">wfmlabs</a>'
			});   // .addTo(map) loads this as the initial basemap	;

			let osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
			    maxZoom: 19,
			    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});

            let topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        	    maxZoom: 19,
        	    attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
			});

            let aerial = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                maxZoom: 19,
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);	


			// name set of tilelayers and adds them to the layer-selector

			/*

			// loading a GeoJSON file. In this sample: Post-office-data from OpenStreetMap 
			$.getJSON("data/sampledata_postoffices.geojson",function(data){
			// L.geoJson function is used to parse the geojson file and load it onto the map
			var datalayer = L.geoJson(data ,{
				//popups and their content are defined here
				onEachFeature: function(feature, featureLayer) {
				featureLayer.bindPopup(feature.properties.name);
				}
			}).addTo(map);
			// command centers and zooms the map to the bounds of datalayer
			//map.fitBounds(datalayer.getBounds());
			});

			L.control.layers(baseMaps).addTo(map);

			*/
	
			 //
			 //loading a JS-File with geoJSON information
			 //


			 // define Popups for all features in map 

			
			function onEachFeature(feature, layer) {
				let popupContent = "<b> Sweet Popup Title</b><br>"; //define popuptitle here, if needed. fails to load if it references missing key in one the elements

			// iterate through all properties of all features and display them in popup
		        Object.keys(feature.properties).forEach(function(key,index) {
		            popupContent = popupContent + "<b>" + key + ":</b> " + feature.properties[key] + "<br>";
		        });

				if (feature.properties && feature.properties.popupContent) {
					popupContent += feature.properties.popupContent;
						}

						layer.bindPopup(popupContent);
					}



			//select datasources and apply style
			let circles = L.geoJSON([postoffices], {
				style: function (feature) {
					return feature.properties && feature.properties.style;
				},
				// uncomment below to allow popups for this layer
				 onEachFeature: onEachFeature,
		
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						radius: 8,
						fillColor: "#ff7800",
						color: "#000",
						weight: 1,
						opacity: 1,
						fillOpacity: 0.8
					});
				}
			});

			//select datasources and apply style
			let borders = L.geoJSON([provinces], {
				style: function (feature) {
					return {
						weight: 2,
						opacity: 0.9,
						color: '#eeeeee',
						//dashArray: '2',
						fillOpacity: 0.1,
						fillColor: 'ffffff'
					};
				},

			}).addTo(map);

			// zooms to extent of clicked region
			// assumes that borders are a path or polygon, not a point
			//borders.on("click", function (event) {
			//    map.fitBounds(event.layer.getBounds());
			//});

        var color_cluster_with_few_buildings = "lightgray"
        var color_cluster_with_many_buildings = "red"

        var highlightStyle = {
            fillColor: "#0044ff",
            fillOpacity: 0.5,
            stroke: true,
            fill: true,
            color: "#0044ff",
            opacity: 0.5,
            weight: 2
        };


            let vecTileLayer = L.vectorGrid.protobuf("data/temporary_tiles/{z}/{x}/{y}.pbf", {
                    rendererFactory: L.canvas.tile,
                    vectorTileLayerStyles: {
                        cluster: function(prop, zoom) {
                            if (prop.building < 250) {
                                amountcolor = "red";
                            } else {
                                amountcolor = "green";
                            }
                            return {
                                fill: true,
                                fillColor: amountcolor,
                                fillOpacity: 0.5,
                                color: "blue",
                                weight: 1
                            };
                        },
                    },
                    maxZoom: 15,
                    minZoom: 5,
                    interactive: true,
                getFeatureId: function(f) {
                    if (f.properties.ID !== undefined) {
                        return f.properties.ID;
                    }
                    if (f.properties.type !== undefined) {
                        return "g" + f.properties.ID;
                    }
                    return "r" + f.properties.OBJECTID;
                }
            })
            .on("click", function(e) {
                this.clearHighlight();
                let properties = e.layer.properties;
                if (properties.ID !== undefined) {
                    var type = "c";
                    var ID = properties.ID;
                    let public=["School","Healthcare","Water Point","Public Building"].filter(function (v,i){i++;return i==properties.SC||i==properties.HC*2||i==properties.WC*3||i==properties.PC*4}).join(",<br/>");
                    public=public||"No Data";
                    var popup='\
                    <table>\
                      <tr><td align="right"><b>ID</b>:</td><td>'+properties.ID+'</td></tr>\
                      <tr><td align="right"><b>Buildings</b>:</td><td>'+properties.building+'</td></tr>\
                      <tr><td align="right"><b>Area</b>:</td><td>'+properties.area_km2 + ' km²' + '</td></tr>\
                      <tr><td align="right"><b>Density</b>:</td><td>'+properties.density+'</td></tr>\
                      <tr><td align="right"><b>Priority Class</b>:</td><td>'+properties.prio_class+'</td></tr>';

                    popup=popup+'\
                    </table>';
                } else {
                    var type = "r";
                    var ID = "r" + properties.ID;
                }
                if (type != "r") {
                    L.popup()
                        .setContent(popup)
                        .setLatLng(e.latlng)
                        .openOn(map);
                    this.highlight = properties.ID;

                    this.setFeatureStyle(ID, highlightStyle);
                    L.DomEvent.stop(e);
                }
            });
        vecTileLayer.highlight = null;
        vecTileLayer.hidden = null;
        vecTileLayer.hiddenstyle = {
            fillColor: "lightgray",
            fillOpacity: 0.1,
            opacity: 0.1,
            fill: true
        };
        vecTileLayer.clearHidden = function() {
            if (this.hiddenIDs) {
                for (let i = 0, len = this.hiddenIDs.length; i < len; i++) {
                    let id = this.hiddenIDs[i];
                    this.resetFeatureStyle(id);
                }
            }
        };
        vecTileLayer.clearHighlight = function() {
            if (this.highlight) {
                if (this.hiddenIDs && this.hiddenIDs.indexOf(this.highlight) > -1){
                    this.setFeatureStyle(this.highlight, this.hiddenstyle);
                } else {
                    this.resetFeatureStyle(this.highlight);
                }
            }
            this.highlight = null;
        };
                

        map.addLayer(vecTileLayer);
        map.on("click", function() {
            vecTileLayer.clearHighlight();
        });
        map.on("popupclose", function() {
            vecTileLayer.clearHighlight();
        });

 
        var sidebar = L.control.sidebar('sidebar', {
            position: 'left'
        });

        L.control.zoom({
            position: "topright"
        }).addTo(map);


        map.addControl(sidebar);

			let baseMaps = {
                "Esri Aerial": aerial,
				"Grayscale": gray,
				"OpenStreetMap": osm,
				"OpenTopoMap": topo,
			};



			// define and include overlaymaps
			let overlaymaps = {
				"Postoffices": circles,
				"Borders": borders,
                "Clusters": vecTileLayer,
			};

        L.control.scale({
            position: "bottomright"
        }).addTo(map);

            map.on("layeradd",function (){vecTileLayer.bringToFront();});


            toggleVecTileLayer();
            toggleBorders();

            map.on('zoomend', function() {
                RefreshPreview();
            });
            map.on('moveend', function() {
                RefreshPreview();
            });

		</script>
	
		
	</body>

</html>



